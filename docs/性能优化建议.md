如果你遇到了性能问题（卡顿、延迟、功耗过高等），本文档可能有所帮助。

下面是一些你可能面临的情况：

## 我的显卡性能不足

如果你无法流畅使用一些有较高性能要求的效果（如 Anime4K、AdaptiveSharpen 等），请尝试下面的操作：

1. 更换为性能需求更低的效果。如 Anime4K_Upscale_S 比 Anime4K_Upscale_L 快的多，CAS 比 AdaptiveSharpen 快的多，它们可以有效提高流畅度，代价是一定程度的画面质量损失。
2. 尝试更换捕获模式。建议你每种模式都尝试一下。

## 间歇性卡顿

假设你的显卡性能对于运行 Magpie 绰绰有余，但依然遇到卡顿问题。请尝试下面的操作：

<details>
    <summary>对于 Nvidia 用户</summary>

### 假设您使用的是 Windows 11 24H2

以下提示仅适用于 Nvidia 用户。Nvidia 显卡的驱动程序配置不当可能是造成卡顿的原因。

#### 缩放一段时间后出现奇怪的帧率下降

刚开始时一切正常（游戏 60 FPS / Magpie 60 FPS），但大约 10~15 秒后，游戏和 Magpie 的帧率都会下降到 37 FPS 左右，同时 GPU 占用率飙升至 100%，GPU 频率从约 1000MHz 降至 700MHz。

首先，如果你在游戏时使用了“电源管理模式：最佳功耗”，尝试将 Magpie 设为“首选最大性能”或“自适应”（我尚未测试“自适应”模式，效果不保证）。游戏本身保持“最佳功耗”模式即可。这样设置后，GPU 频率将不会异常下降。

#### Nvidia App 与 Nvidia 控制面板

不过，我的一台电脑即便使用上述方法仍然无法解决，而其他设备都能正常恢复。经过调查发现，Nvidia App 和 Nvidia 控制面板之间存在兼容性问题。如果你使用 Nvidia App 修改了驱动设置，然后在控制面板中修改相同的设置，可能会导致控制面板崩溃，或出现“访问被拒绝”的错误。此外，Nvidia App 进行的驱动设置更改不会真正应用到游戏或程序。

如果你使用的是 Nvidia App 11.0.2.341 版本，并搭配 572.16 版驱动，请不要通过 Nvidia App 调整 Nvidia 驱动设置。解决方案如下：

1. 关闭 Nvidia App 和 Nvidia 控制面板。
2. 进入 C:\ProgramData\NVIDIA Corporation\Drs 目录，删除所有 .bin 文件，例如 nvdrsdb0.bin、nvdrsdb1.bin、nvdrssel.bin、update.bin 等。
3. 重新打开 Nvidia 控制面板，手动重新配置所有全局设置和特定程序的设置。
4. 之后避免使用 Nvidia App 修改驱动设置。

#### 画面看起来不如原生游戏窗口流畅

使用 `Graphics Capture` 或 `Desktop Duplication` 时，即使游戏和 Magpie 都是 60 FPS，画面仍然不够流畅。

调查结果表明，这可能与垂直同步有关。至少在 Windows 11 24H2 版本中，游戏必须开启垂直同步，才能保证 WGC 和 DXGI 捕获模式不会丢帧。否则，即使捕获和游戏都运行在 60 FPS，仍可能发生帧丢失或重复帧现象。

推荐的垂直同步设置：

* 游戏：使用传统垂直同步模式，例如：
  * “使用 3D 应用程序设置”并在游戏内启用 V-Sync
  * 直接选择“垂直同步：开”
* 不要使用以下选项：
  * 关闭垂直同步
  * “垂直同步：快速”模式
* 未测试但可能有效的选项：
  * “垂直同步：自适应 / 自适应（半刷新率）”

对于 Magpie，请选择“使用 3D 应用程序设置”。

#### 使用 Desktop Duplication 时丢帧严重

即使游戏 60 FPS / Magpie 60 FPS，仍然会遇到大量丢帧问题。我发现这种情况出现在 Magpie v0.10.6 版本。解决方法：

* 在 Magpie 设置中启用垂直同步，并在 Nvidia 控制面板中将 Magpie 的垂直同步设置为“使用 3D 应用程序设置”。
* 升级到 Magpie v0.11.1 也能解决此问题。

#### 屏幕看起来不流畅，但 FPS 不错

游戏 60 FPS / Magpie 60 FPS / 显示器 60 Hz，但渲染后有些帧丢失，而不是显示在屏幕上。这也发生在没有使用缩放的本机游戏窗口上。

检查最大帧速率和垂直同步。例如，您有 60 Hz 显示器并如上所述设置垂直同步，如果您之前将最大帧速率设置为 60 FPS，您还需要删除最大帧速率设置。

如果您有其他帧限制器（如 MSI Afterburner RTSS），也请将其关闭。

误区：
1. 将全局最大帧速率设置为 60 FPS 并关闭某些程序的最大帧速率，这将无法按预期工作。当您关闭程序最大帧速率和垂直同步时，但您有全局最大帧速率，游戏和Magpie仍遵循全局最大帧速率限制。
1. 使用最大帧速率作为“更好的垂直同步方法”，因为他们说“这样做可以减少输入延迟”。不，最大帧速率不是垂直同步，它不能保证每个渲染的帧都出现在显示器上，这是“老式垂直同步”才能做到的。

#### 低延迟模式

如果遇到其他奇怪的现象，可以检查这些选项。我不确定 Magpie 是否有这些问题，但对于 Lossless Scaling，使用“低延迟模式：超高”会导致 WGC API 缩放后拖拽鼠标时，释放鼠标按钮后鼠标位置和释放按钮时不一致。

为 Magpie 设置“低延迟模式：关闭”。但是，如果需要，您可以为游戏保留“低延迟模式：超高”，并且您知道这不会导致错误。例如，一些旧的 DirectX 9 游戏无法很好地使用此设置，它会导致帧丢失和输入延迟，如果发生这种情况，只需将其设置为关闭即可。

</details>

<details>
    <summary>对于 AMD 用户</summary>

欢迎分享更多性能优化技巧！你也可以查看 Nvidia 相关建议，看看其中哪些适用于你的配置。

</details>

<details>
    <summary>超线程和大小核CPU</summary>

#### 超线程与 Intel Alder Lake 大小核架构 CPU

如果你不想关闭超线程，可以使用批处理命令来限制游戏和 Magpie 的 CPU 亲和性（Affinity）。对游戏或其启动器使用 cmd.exe 批处理 `start /affinity 0x55 "" "C:\path to\game.exe"`，游戏将继承父进程的 CPU 亲和性。对 Magpie 使用 `start /affinity 0xaa`。此外，你还可以调整游戏图形设置，尽量将游戏的 CPU 占用控制在 50% 以下（以 4 核 8 线程 CPU 为例，相当于使用 4 个物理核心）。

0x55 指定游戏在 4 核 CPU 的 0 2 4 6 逻辑核心上运行，0xaa 指定其他程序在 1 3 5 7 上运行。

如果需要提高进程优先级，可以使用 `start /abovenormal` 为游戏和 Magpie 设置“高于正常”优先级。但需要注意，某些游戏在设置 CPU 亲和性和提高进程优先级后可能更容易崩溃，具体原因不明。例如，dwm.exe 系统服务本身就以“高”优先级运行。若遇到稳定性问题，可以考虑改用高性能电源计划，让 CPU 长时间运行在最高频率。

0x55 和 0xaa 只是示例值，你可以使用 [Bitsum CPU 亲和性计算器](https://bitsum.com/tools/cpu-affinity-calculator) 来计算适合自己 CPU 的值。

此外，你也可以利用这种方法，强制游戏仅运行在 Intel Alder Lake 大小核架构的“大核”上，以获得更好的性能。

参考：
https://superuser.com/questions/690509/does-windows-know-how-to-appropriately-assign-threads-to-a-quad-core-processor-t

</details>

### 仍然卡顿？
1. 更换捕获模式。建议你每种模式都尝试一下。
2. 打开“禁用 DirectFlip”。DirectFlip 是一个用于降低输入延迟的技术，但可能和某些游戏不兼容。
3. 试试切换使用的显卡。
4. 提高 Magpie 的进程优先级以及在驱动中提高 Magpie 的优先级（如果有这个选项）。
5. 如果上面的尝试不起作用，请提交一个 [Issue (Performance)](https://github.com/Blinue/Magpie/issues/new?assignees=&labels=performance&template=02_performance.yaml)。

## 我想降低 Magpie 的功耗

在需要节省电量或降低发热时，请尝试下面的操作：

1. 限制帧率。
2. 更换为性能需求更低的效果。
