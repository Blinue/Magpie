如果你遇到了性能问题（卡顿、延迟、功耗过高等），本文档可能有所帮助。

下面是一些你可能面临的情况：

## 我的显卡性能不足

如果你无法流畅使用一些有较高性能要求的效果（如 Anime4K、AdaptiveSharpen 等），请尝试下面的操作：

1. 更换为性能需求更低的效果。如 Anime4K_Upscale_S 比 Anime4K_Upscale_L 快的多，CAS 比 AdaptiveSharpen 快的多，它们可以有效提高流畅度，代价是一定程度的画面质量损失。
2. 尝试更换捕获模式。建议你每种模式都尝试一下。

## 间歇性卡顿

假设你的显卡性能对于运行 Magpie 绰绰有余，但依然遇到卡顿问题。请尝试下面的操作：

<details>
    <summary>对于 Nvidia 用户</summary>

### 假设您使用的是 Windows 11 24H2
以下提示仅适用于 Nvidia 用户。Nvidia 显卡的驱动程序配置不当可能是造成卡顿的原因。

#### 启用放大一段时间后，fps 奇怪地下降
一开始，一切都很好（游戏 60 FPS / Magpie 60 FPS）。但大约 10 到 15 秒后，游戏和 magpie fps 都下降到大约 37 FPS，同时 GPU 使用率上升到 100%，GPU MHz 从 1000 下降到 700。

首先，如果您使用“电源管理模式：最佳功率”玩游戏，请尝试将 magpie 程序设置为“首选最大性能”或“自适应”，但我还没有尝试自适应模式，但不能保证。游戏保持“最佳功率”就没问题。通过使用此设置，GPU MHz 将不再异常下降。

#### Nvidia App 和 Nvidia 控制面板
但是，我的一台电脑无法使用此设置，而其他电脑可以用这种方式修复。调查结果是，Nvidia App 和 Nvidia 控制面板之间存在兼容性问题。如果您使用 Nvidia App 更改了驱动程序设置，请打开控制面板，修改相同的设置会导致控制面板崩溃或显示“拒绝访问”。并且通过 Nvidia App 进行的设置对于游戏或程序根本不起作用。

不要使用 Nvidia App（版本 11.0.2.341）调整驱动程序（如 572.16）的 Nvidia 驱动程序设置。关闭 Nvidia App 和 Nvidia 控制面板，转到 `C:\ProgramData\NVIDIA Corporation\Drs`，删除所有 `.bin` 文件（如 `nvdrsdb0.bin`、`nvdrsdb1.bin`、`nvdrssel.bin`、`update.bin`），再次打开 Nvidia 控制面板并重新执行所有全局设置和程序指定的设置，之后避免使用 Nvidia App 驱动程序设置。

#### 屏幕看起来不如原生游戏窗口流畅
Game 60 FPS / Magpie 60 FPS，出现在 `Graphics Capture` 或 `Desktop Duplication` 中。

调查结果是垂直同步。虽然看起来很奇怪。至少对于 Windows 11 24H2，您需要为游戏打开垂直同步，以使 WGC 和 DXGI 捕获不会丢失帧。如果不这样做，即使 WGC 和 DXGI 以 60 FPS 捕获并且游戏以 60 FPS 运行，许多或一些游戏帧也会丢失或称为重复帧。

游戏所需的垂直同步模式是“传统/经典/垂直同步：使用 3D 应用程序设置，并启用游戏内垂直同步/垂直同步：开启”。不要关闭垂直同步，或使用“垂直同步：快速”。我不确定“垂直同步：自适应/自适应（半刷新率）”是否有效，但我没有时间进行详细测试。

对于 magpie，请使用“使用 3D 应用程序设置”。

#### 使用 Desktop Duplication 时大量丢失 fps
同时，游戏 60 FPS / Magpie 60 FPS。我发现在使用 Magpie v0.10.6 时会出现这种情况。在 Magpie 设置中启用垂直同步，并对 Magpie 程序设置使用“垂直同步：使用 3D 应用程序设置”解决了这个问题。升级到 Magpie v0.11.1 也解决了这个问题。

#### 低延迟模式和最大帧速率
如果您遇到其他奇怪的行为，请检查这些选项。我不确定 Magpie 是否有这些问题，但对于 Lossless Scaling，使用“低延迟模式：超高”会导致 WGC API 放大后拖拽鼠标时，释放鼠标按钮后鼠标位置和释放按钮时不一致。

为 Magpie 设置“低延迟模式：关闭”和“最大帧速率：关闭”。
对于游戏，设置“最大帧速率：关闭”，但如果需要，您可以为游戏保留“低延迟模式：超高”。

</details>

<details>
    <summary>对于 AMD 用户</summary>

### Placeholder
欢迎为我们提供更多性能提示。您也可以查看 Nvidia 提示并猜测某些条件是否符合您的设置。

</details>

<details>
    <summary>超线程和大小核CPU</summary>

#### 超线程和 Intel Alder Lake big.little CPU
我建议，如果您不想关闭超线程，请对游戏或其启动器使用 cmd.exe 批处理 `start /affinity 0x55 "" "C:\path to\game.exe"`，游戏将继承父进程亲和性。对 Magpie 使用 `start /affinity 0xaa`。同时调整游戏图形选项，尝试将游戏 CPU 使用率限制在 50% 以下（以 4 核 8 线程的 4 个物理核心为例）。

0x55 指定游戏在 4 核 CPU 的 0 2 4 6 逻辑核心上运行，其他东西 0xaa 在 1 3 5 7 上运行。

对于高优先级，对游戏和 Magpie 都使用 `start /abovenormal`，但我发现某些游戏很容易在亲和性和较高优先级的情况下崩溃，原因不明。 举例来说，`dwm.exe` 系统服务以`高` 运行。在这种情况下，使用高性能电源计划使CPU以最高时钟速度运行是最后选择。

0x55 和 0xaa 是示例值，我使用 https://bitsum.com/tools/cpu-affinity-calculator

您也可能利用此技巧强制游戏在 Intel Alder Lake big.little CPU 的大核上运行。

参考：
https://superuser.com/questions/690509/does-windows-know-how-to-appropriately-assign-threads-to-a-quad-core-processor-t

</details>

### 仍然卡顿？
1. 更换捕获模式。建议你每种模式都尝试一下。
2. 打开“禁用 DirectFlip”。DirectFlip 是一个用于降低输入延迟的技术，但可能和某些游戏不兼容。
3. 试试切换使用的显卡。
4. 提高 Magpie 的进程优先级以及在驱动中提高 Magpie 的优先级（如果有这个选项）。
5. 如果上面的尝试不起作用，请提交一个 [Issue (Performance)](https://github.com/Blinue/Magpie/issues/new?assignees=&labels=performance&template=02_performance.yaml)。

## 我想降低 Magpie 的功耗

在需要节省电量或降低发热时，请尝试下面的操作：

1. 限制帧率。
2. 更换为性能需求更低的效果。
