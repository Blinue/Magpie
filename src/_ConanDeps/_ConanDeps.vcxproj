<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|ARM64">
      <Configuration>Debug</Configuration>
      <Platform>ARM64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|ARM64">
      <Configuration>Release</Configuration>
      <Platform>ARM64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <Keyword>Win32Proj</Keyword>
    <ProjectGuid>{456ccae4-2c51-4cf2-8d3a-1efce8c41a2d}</ProjectGuid>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
    <OutDir>$(SolutionDir)\bin\$(Platform)\$(Configuration)\</OutDir>
    <IntDir>$(SolutionDir)\obj\$(Platform)\$(Configuration)\$(MSBuildProjectName)\</IntDir>
  </PropertyGroup>
  <PropertyGroup>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup>
    <ConfigurationType>Utility</ConfigurationType>
    <PlatformToolset>v143</PlatformToolset>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="PropertySheets">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ItemGroup>
    <Text Include="conanprofile.txt" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <UsingTask TaskName="FindConanFiles" TaskFactory="RoslynCodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll">
    <ParameterGroup>
      <SrcDir Required="true" />
      <ConanFile ParameterType="Microsoft.Build.Framework.ITaskItem[]" Output="true" />
    </ParameterGroup>
    <Task>
      <Using Namespace="System" />
      <Using Namespace="System.IO" />
      <Using Namespace="System.Collections.Generic" />
      <Using Namespace="Microsoft.Build.Framework" />
      <Code Type="Fragment" Language="cs"><![CDATA[
List<ITaskItem> conanFiles = new List<ITaskItem>();

// 搜索 conanfile.txt
foreach (string projectDir in Directory.GetDirectories(SrcDir)) {
    string conanfilePath = Path.Combine(projectDir, "conanfile.txt");
    if (!File.Exists(conanfilePath)) {
        continue;
    }
    
    string projectName = projectDir.Substring(projectDir.LastIndexOf('\\') + 1);
    conanFiles.Add(new TaskItem(conanfilePath, new Dictionary<string, string> { { "ProjectName", projectName } }));
}

ConanFile = conanFiles.ToArray();
      ]]></Code>
    </Task>
  </UsingTask>
  <PropertyGroup>
    <ConanInstallOutputDir>..\..\.conan\</ConanInstallOutputDir>
  </PropertyGroup>
  <Target Name="BuildConanDeps" BeforeTargets="Build">
    <FindConanFiles SrcDir="$(ProjectDir)..">
      <Output TaskParameter="ConanFile" ItemName="ConanFile" />
    </FindConanFiles>
    <PropertyGroup>
      <ConanInstallArch Condition="'$(Platform)' == 'x64'">x86_64</ConanInstallArch>
      <ConanInstallArch Condition="'$(Platform)' == 'ARM64'">armv8</ConanInstallArch>
    </PropertyGroup>
    <!-- 批量处理 ConanFile 中的元素 -->
    <Exec Command="conan install &quot;%(ConanFile.FullPath)&quot; -pr:a=conanprofile.txt --output-folder $(ConanInstallOutputDir)%(ConanFile.ProjectName) --build=missing -s build_type=$(Configuration) -s arch=$(ConanInstallArch) --update" />
  </Target>
  <!-- 清理 Conan 生成的 props 文件 -->
  <Target Name="CleanConanProps" BeforeTargets="Clean">
    <Exec Command="rmdir /s /q $(ConanInstallOutputDir)" Condition="Exists('$(ConanInstallOutputDir)')" />
  </Target>
</Project>